#!/usr/bin/env bash
# Install and configure HAProxy as a load balancer for web-01 and web-02

apt-get update -y
apt-get install -y haproxy

# Enable HAProxy to be managed via init script
# (needed on Ubuntu so that `service haproxy start` actually starts it)
if grep -q "^ENABLED=" /etc/default/haproxy; then
    sed -i 's/^ENABLED=.*/ENABLED=1/' /etc/default/haproxy
else
    echo "ENABLED=1" >> /etc/default/haproxy
fi

# Configure HAProxy - overwrite with a simple, valid config
cat > /etc/haproxy/haproxy.cfg << 'EOF'
global
    log /dev/log local0
    log /dev/log local1 notice
    daemon
    maxconn 256

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000

frontend http-in
    bind *:80
    default_backend web-backend

backend web-backend
    balance roundrobin
    server web-01 54.210.242.6:80 check
    server web-02 44.211.154.38:80 check
EOF

# Start / restart HAProxy
service haproxy restart